{% extends 'data/base_data.html' %}

{% load static %}

{% block title %} Data Overview {% endblock title %}

{% block company %} {{ CompanyName }} {% endblock company %}
{% block companyMenu %} {{ CompanyName }} {% endblock companyMenu %}
{% block appName %} DATA OVERVIEW {% endblock appName %}
{% block Type %} SMART CAMERAS {% endblock Type %}

{% block content %}

<!-- SEARCH ROW -->
<div class="row align-items-center">
  <div class="col-xl-6 col-sm-6 mb-xl-0 mb-6">
    
  </div>
  <div class="col-xl-6 col-sm-6 mb-xl-0 mb-6">
    <form method="GET">{% csrf_token %}
      <div class="row">


        <div class="col-xl-6 col-sm-4 mb-4">
          <div class="input-group input-group-outline">
            <input class="form-control datetimepicker text-center" value="{{object_list.intervalDate}}" type="text"
              placeholder="today" id="dateKword" name="dateKword" />
          </div>

        </div>
        <div class="col-xl-6 col-sm-4">
          <button class="btn bg-gradient-primary" type="submit"> Search </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- HEAD WIDGETS -->
<div class="row">
  
  <!-- CAMERA DATA -->
  <div class="col-lg-6 col-sm-6">
    <div class="bg-gradient-secondary shadow-dark border-radius-lg py-3 pe-1">
      <div class="container">
        <div class="row">
          <div class="col-8 my-auto">
            <div class="numbers">
              <p class="text-white text-sm mb-0 font-weight-bold">Data for:  {{object_list.data.0.DateCreate|date:'d/m/Y H:i'}}</p>
              <h6 class="text-white font-weight-bolder mb-0">
                {{object_list.VisualSamplingPointName}} - {{object_list.data.0.Temperature|floatformat:2}} °C 
              </h6>
            </div>
          </div>
          <div class="col-4 text-end">
            <img class="w-25" src="{% static 'assets/img/sun.png' %}" alt="image sun">
            <h6 class="mb-0 text-white text-end me-3">{{object_list.data.0.Humidity|floatformat:2}} %</h6>
          </div>
        </div>
      </div>
    </div>
  </div>
    
  <div class="col-lg-3 col-sm-3">
    <div class="card mb-4">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-4">
            <div class="icon icon-lg icon-shape bg-gradient-success shadow text-center border-radius-md">
              <i class="fas fa-bug opacity-10"></i>
            </div>
          </div>
          <div class="col-8 my-auto text-end">
            <p class="text-sm mb-0  font-weight-bold">Total identified</p>
            <h5 class="font-weight-bolder mb-0">
              3
            </h5>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-sm-3">
    <div class="card mb-4">
      <div class="card-body p-3">
        <div class="row">
          <div class="col-4">
            <div class="icon icon-lg icon-shape bg-gradient-primary shadow text-center border-radius-md">
              <i class="fas fa-car-battery opacity-10"></i>
            </div>
          </div>
          <div class="col-8 my-auto text-end">
            <p class="text-sm mb-0 font-weight-bold">Battery voltaje</p>
            <h5 class="font-weight-bolder mb-0">
              {{object_list.data.0.vol|floatformat:2}} V
            </h5>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="card mb-4">
  <div class="card-header pb-0">
      <div class="row">
          <div class="col-lg-6 col-7">
              <h6>Historical data</h6>
          </div>
          <div class="col-lg-6 col-5 my-auto text-end">
          </div>
      </div>
  </div>

  <!-- line chart -->
  <div class="card-body px-0 pb-2">
      
      <div class="chart">
        <div ui-jp="plot"  id = "AllPlots" style="height: 300px;"></div>
        <!-- <canvas id="chart-line" class="chart-canvas" height="300"></canvas> -->
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header pb-0">
      <div class="row">
          <div class="col-lg-6 col-7">
              <h6>Historical table</h6>
          </div>
          <div class="col-lg-6 col-5 my-auto text-end">
              <div class="text-end p-3">
                  <button class="btn bg-gradient-info btn-sm mb-0 export" data-type="csv" type="button">
                      <span class="btn-inner--icon"><i class="fas fa-file-csv text-lg"></i> </span>
                      <span class="btn-inner--text">&nbsp;&nbsp;&nbsp;Export CSV</span>
                  </button> 
              </div>
          </div>
      </div>
  </div>

  <!-- datatable -->
  <div class="card-body p-0">

      <div class="table-responsive p-0">
          <table class="table align-items-center justify-content-center mb-0" id="datatable-rodPump">
              <thead>
                  <tr>
                      <th class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7">Date Time</th>
                      <th class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7 ps-0">Temp °C</th>
                      <th class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7 ps-0">Hum %</th>
                      <th class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7 ps-0">Class</th>
                      <th class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7 ps-0">Quantity</th>
                      <th class="text-uppercase text-secondary text-xs font-weight-bolder opacity-7 ps-0">Volt</th>
                  </tr>
              </thead>
              <tbody>
                  {% for j in object_list.data %}
                  <tr>
                      <td class="text-sm font-weight-normal text-start">{{j.DateCreate|date:'m-d-Y H:i'}}</td>
                      <td class="text-sm font-weight-normal text-start">{{j.Temperature|floatformat:2}}</td>
                      <td class="text-sm font-weight-normal text-start">{{j.Humidity|floatformat:2}}</td>
                      <td class="text-sm font-weight-normal text-start"> {% for i in j.Classes %} <p class="mb-0">{{i}} {{ get_i_display }} </p> {% endfor %}</td>
                      <td class="text-sm font-weight-normal text-start"> {% for i in j.Quantity %} <p class="mb-0">{{i}} </p> {% endfor %}</td>
                      <td class="text-sm font-weight-normal text-start">{{j.vol|floatformat:2}}</td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
  </div>
</div>

{% endblock content %}

{% block JSscripts %}

<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>

<script>
    const dataTableBasic1 = new simpleDatatables.DataTable("#datatable-rodPump", {
        searchable: true,
        fixedHeight: false,
        perPage: 10
    });

    document.querySelectorAll(".export").forEach(function (el) {
        el.addEventListener("click", function (e) {
            var type = el.dataset.type;

            var data = {
                type: type,
                filename: "data_exports",
            };

            if (type === "csv") {
                data.columnDelimiter = ",";
            }

            dataTableBasic1.export(data);
        });
    });
</script>

<script src="{% static 'assets/js/plugins/plotly-2.12.1.min.js' %}"></script>
<script>

  let dt = [];
  let Te = [];
  let Hu = [];
  let Ba = [];

  '{% for value in object_list.data %}'
      Te.push("{{value.Temperature}}");
      Hu.push("{{value.Humidity}}");
      Ba.push("{{value.vol}}");
      var ddt = new Date("{{value.DateCreate|date:'m-d-y H:i'}}");
      dt.push(ddt);
  '{% endfor %}'

  var layout = {
    margin: {l:40,t:0,b:50,r:30},
    autosize: true,

    xaxis: {
        autorange: true,
        showgrid: true,
        zeroline: true,
        rangeselector: {buttons: [
        {
          count: 1,
          label: '1d',
          step: 'day',
          stepmode: 'backward'
        },
        {
          count: 1,
          label: '1w',
          step: 'week',
          stepmode: 'backward'
        },
          {step: 'all'}
        ]},
      //range: ['2020-01-01', '2020-01-31'],
        
        type: 'date'
      },
    yaxis: {
      autorange: true,
      showgrid: true,
      zeroline: true,
      range: [0, 30],
    type: 'linear'
    },
    legend: {
        x: 0.5,
        y: 1,
        traceorder: 'normal',
        font: {
          family: 'sans-serif',
          size: 12,
          //color: '#254'
        },
        bgcolor: '#E2E2E2',
        //bordercolor: '#FFFFFF',
        //borderwidth: 2
      }
  }

  var config = {
    modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d', 'zoomOut2d'],
    responsive: true,
    displaylogo: false
  }

  var trace0 = {
    x: dt,
    y: Te,
    type: 'scatter',
    mode: "lines+markers",
    name: 'Temp',
    line: {shape: 'spline'},
  };

  var trace1 = {
    x: dt,
    y: Hu,
    type: 'scatter',
    mode: "lines+markers",
    name: 'Hum',
    line: {shape: 'spline'},
  };

  var trace2 = {
    x: dt,
    y: Ba,
    type: 'scatter',
    mode: "lines+markers",
    name: 'Vol',
    line: {shape: 'spline'},
  };

  var data = [trace0, trace1, trace2];

  Plotly.newPlot('AllPlots', data, layout, config);

</script>

<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>
<script>
    if (document.querySelector('.datetimepicker')) {
        flatpickr('.datetimepicker', {
            allowInput: true,
            mode: "range"
        }); // flatpickr
    }
</script>

{% endblock JSscripts %}